name: build mreg-api

on:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+*"

concurrency:
    group: build-mreg-api-${{ github.head_ref }}

env:
    UV_FROZEN: 1

jobs:
    build_pypi:
        name: Build wheels and source distribution
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history to verify tag is on main

            - name: Exit if tag is not on main branch
              run: |
                  if ! git branch -r --contains HEAD | grep -q 'origin/main'; then
                    echo "Error: Tagged commit is not on the main branch"
                    exit 1
                  fi

            - name: Install uv
              uses: astral-sh/setup-uv@v2

            - name: Set up Python 3.12
              run: uv python install 3.12

            - name: Install build dependencies
              run: uv sync

            - name: Build source distribution
              run: uv build

            - uses: actions/upload-artifact@v4
              with:
                  name: pypi_artifacts
                  path: dist/*
                  if-no-files-found: error

    publish_github:
        name: Publish GitHub release
        needs:
            - build_pypi
        runs-on: ubuntu-latest

        steps:
            - name: Download wheel and source distributions
              uses: actions/download-artifact@v4
              with:
                  pattern: pypi_artifacts
                  path: dist
                  merge-multiple: true

            - name: Generate SHA256 checksums
              id: sha
              run: |
                  cd dist
                  echo "checksums<<EOF" >> $GITHUB_OUTPUT
                  sha256sum * >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create GitHub release
              uses: softprops/action-gh-release@v2
              with:
                  files: dist/*
                  body: |
                      Release ${{ github.ref_name }}

                      ## Installation Instructions

                      ### uv

                      ```bash
                      uv tool install mreg-api==${{ github.ref_name }}
                      ```

                      ### pipx

                      ```bash
                      pipx install mreg-api==${{ github.ref_name }}
                      ```

                      ### pip

                      ```bash
                      pip install mreg-api==${{ github.ref_name }}
                      ```

                      ## SHA256 Checksums
                      ```
                      ${{ steps.sha.outputs.checksums }}
                      ```
                  draft: false
                  prerelease: false

    # GitHub releases can be republished, but PyPI uploads are permanent.
    # Ensure all steps succeed before publishing to PyPI.
    publish_pypi:
        name: Publish PyPI release
        needs:
            - build_pypi # redundant but explicit
            - publish_github
        runs-on: ubuntu-latest
        permissions:
            id-token: write
        steps:
            - uses: actions/download-artifact@v4
              with:
                  name: pypi_artifacts
                  path: dist

            - name: Push build artifacts to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1

    rollback_on_failure:
        name: Rollback on publish failure
        if: ${{ always() && (needs.publish_github.result == 'failure' || needs.publish_pypi.result == 'failure') }}
        needs:
            - publish_github
            - publish_pypi
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Rollback GitHub release and tag
              if: ${{ needs.publish_github.result == 'success' }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "Deleting GitHub release..."
                  gh release delete ${{ github.ref_name }} --repo ${{ github.repository }} --yes || true

                  echo "Deleting git tag..."
                  git push --delete origin "refs/tags/${{ github.ref_name }}" || true
            - name: Rollback notification
              run: |
                  echo "::notice::Rolling back release ${{ github.ref_name }} due to publish failure"
                  echo "GitHub release status: ${{ needs.publish_github.result }}"
                  echo "PyPI publish status: ${{ needs.publish_pypi.result }}"
